define(function(require){var $=require("jquery");var htmlCodes="  \r\n     .nk-musics { background-color: rgba(102, 102, 102, 0.05);position: fixed; left: 0; bottom: 0; width: 300px; padding: 8px; z-index: 4; -webkit-animation: fadeInTop .8s; animation: fadeInTop .8s; box-shadow: rgba(0, 0, 0, 0.1) 0 1px 2px; }\r\n     .nk-musics .nk-music-lists { height: 72px; overflow: auto; }\r\n    .nk-musics .nk-music-lists li { position: relative; line-height: 30px; padding: 3px 8px 3px 40px; font-size: 0; cursor: pointer; }\r\n    .nk-musics .nk-music-lists li:hover { background-color: #f5f5f5 }\r\n    .nk-musics .nk-music-lists li * { position: relative; display: inline-block; vertical-align: top; font-size: 14px; z-index: 10; }\r\n    .nk-musics .nk-music-lists li img { position: absolute; left: 0; border-radius: 50%; width: 30px; height: 30px; }\r\n    .nk-musics .nk-music-lists li.error { background-color: red }\r\n    .nk-musics .nk-music-lists li.this { color: red; }\r\n    .nk-musics .nk-music-lists li:hover { background-color: rgba(255, 255, 255, 0.61); }\r\n    .progress { position: relative; width: 100%; height: 40px }\r\n    .progress__bar { position: absolute; top: 0; left: 55px; right: 47px; height: 40px; overflow: hidden }\r\n    .progress__box { position: absolute; top: 0; left: 8px; right: 8px; z-index: 2; height: 40px }\r\n    .progress__bg, .progress__load, .progress__play { position: absolute; top: 19px; width: 100%; height: 2px; -webkit-transition: width 1s linear; transition: width 1s linear }\r\n    .progress__bg { width: 0; z-index: 3; background-color: rgba(0, 0, 0, .1) }\r\n    .progress__load { width: 0; z-index: 4; background-color: rgba(255, 255, 255, .2) }\r\n    .progress__play { width: 0; z-index: 5; background-color: #31c27c }\r\n    .progress__start, .progress__end { position: absolute; top: 0; z-index: 1; width: 55px; line-height: 40px; text-align: center }\r\n    .progress__start { left: 0 }\r\n    .progress__end { right: 0 }\r\n    .lyric__text { height: 42px; line-height: 42px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;  color: rgba(0,0,0,.6); text-align: center; }\r\n    .lyric{ position: relative; padding: 0 0 5px 50px;font-size: 13px }\r\n    .lyric__play{ position: absolute; left: 0; display: block; width: 43px; height: 43px; border: solid 1px #fff; border-radius: 999px; background: rgba(0,0,0,.1); opacity: .6; }";$("head").append("<style>"+htmlCodes+"</style>");var global={};global.css={parent:"nk-musics",ul:"nk-music-lists",next:"nk-music-next",play:"lyric__play"};var gedan={path:function(){return location.hostname==="localhost"?function(){return global.debug=!0,"/shaonq.github.io/js/json/"}():function(){return global.debug=!1,"//shaonq.github.io/js/json/"}()}(),url:function(l){return this.path+(l||"mp3")+".json"},render:function(d){if(d.data){for(var i=0,j;i<d.data.length;i++){j=d.data[i],global.ul.append('<li data-music-name="'+j.url+'" title="'+j.user+'">'+"<img src="+j.image+" onerror=\"this.src='//imgcache.qq.com/mediastyle/y/img/cover_mine_300.jpg';this.onerror=null;\"><h5>"+(j.name||"换一首吧 (=・ω・=)")+"</h5></li>")}global.parent.append('    <div class="progress">\r\n                    <div class="progress__bar">\r\n                    <div class="progress__box">\r\n                    <div class="progress__bg"></div>\r\n                    <div class="progress__load" style="width:0"></div>\r\n                    <div class="progress__play" style="width:0"></div>\r\n                    </div>\r\n                    </div>\r\n                    <span class="progress__start">00:00</span>\r\n                <span class="progress__end ">00:00</span>\r\n                </div>\r\n                <div class="lyric">\r\n                    <i class="lyric__play"></i>\r\n                    <p class="lyric__text overflow"></p>\r\n                    </div>')}return global.parent},init:function(d){gequ.audio=new Audio,gequ.bind.call(gequ.audio),gedan.render(d).each(function(){global.tools.call(this);global.ul.find("li").each(function(i){gequ.click.call(this,i)})})}};var gequ={path:function(){return"http://oe9kimiz1.bkt.clouddn.com/"}(),src:function(){gequ.name=this.getAttribute("data-music-name");return gequ.path+gequ.name+".mp3"},click:function(i){$(this).on("click",function(){gequ.play.call(this,i)})},play:function(i){return gequ.index=i|0,gequ.audio.src=gequ.src.call(this),gequ.audio.play(),gequ.audio},li:function(i){return global.ul.find("li").eq(i)},removeClass:function(){return global.ul.find("li").removeClass("this"),this},time:function(t){var mm=parseInt(t/60),ss=parseInt(t%60);return ss<10&&(ss="0"+ss),mm+":"+ss},nextPlay:function(){gequ.index<global.ul.find("li").length-1?gequ.index++:gequ.index=0;gequ.li(gequ.index).each(function(){gequ.play.call(this,gequ.index)})},bind:function(){var _this=this,that=$(_this);that.on("error",function(){var error=["ERROR","用户终止","网络错误","解码错误","URL无效"];console.log("%c Error %c","background:red; color:#fff","",error[this.error.code]);gequ.li(gequ.index).addClass("error");gequ.nextPlay();return!1}).on("canplay",function(){lyric.get(gedan.path+gequ.name+".lrc")}).on("play",function(){gequ.removeClass().li(gequ.index).addClass("this")}).on("pause",function(){global.parent.find("li").removeClass("this")}).on("loadedmetadata",function(){global.parent.find(".progress__end").html(gequ.time(this.duration))}).on("timeupdate",function(){var span=global.parent.find(".progress__play");global.parent.find(".progress__start").html(gequ.time(this.currentTime));span.width(this.currentTime/this.duration*100+"%")}).on("ended",gequ.nextPlay).on("progress",function(){if(this.buffered.length===1){if(this.buffered.start(0)==0){var buffered=this.buffered.end(0);var percentage=buffered/this.duration*100;var bar=global.parent.find(".progress__load");bar.width(percentage+"%")}}})}};global.tools=function(){global.parent.find("."+global.css.play).on("click",function(){try{gequ.audio.paused?gequ.audio.play():gequ.audio.pause()}catch(e){gequ.play()}})};global.init=function(l){this.parent=$("."+global.css.parent);if(!this.parent.length){this.parent=$("<div class="+global.css.parent+"><i></i><ul class="+global.css.ul+"></ul></div>"),this.parent.appendTo(document.body),this.ul=this.parent.find("."+global.css.ul)}if("function"!==typeof window.Audio){this.parent.append("<li>浏览器不支持</li>");return}$.getJSON(gedan.url(l),gedan.init)};var lyric={get:function(url){$.ajax({type:"get",url:url,dataType:"text",success:function(e){lyric.append(lyric.parse(e))},error:function(){lyric.append(!1)}})},parse:function(text){var lines=text.split("\n"),pattern=/\[\d{2}:\d{2}.\d{2}\]/g,result=[];while(!pattern.test(lines[0])){lines=lines.slice(1)}lines[lines.length-1].length===0&&lines.pop();lines.forEach(function(v,i,a){var time=v.match(pattern),value=v.replace(pattern,"");time.forEach(function(v1,i1,a1){var t=v1.slice(1,-1).split(":");result.push([parseInt(t[0],10)*60+parseFloat(t[1]),value])})});result.sort(function(a,b){return a[0]-b[0]});return result},append:function(lyric){lyric?function(){$(gequ.audio).on("timeupdate",function(){var t=parseFloat(this.currentTime);for(var i=0,j=lyric.length;i<j;i++){if(t>lyric[i][0]){var ii=i+1,ti=ii>j?0:lyric[ii][0]-lyric[i][0];var html=$("<p>"+lyric[i][1]+"</p>");html.attr({style:"-webkit-animation-duration:"+ti+";animation-duration:"+ti});global.parent.find(".lyric__text").html(html)}}})}():global.parent.find(".lyric__text").html("歌词还在制作中...")}};return global});